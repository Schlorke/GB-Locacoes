# üîß Solu√ß√µes de Problemas - Janeiro 2025

> **√öltima Atualiza√ß√£o**: 15 de Janeiro de 2025  
> **Contexto**: Problemas enfrentados e solucionados durante implementa√ß√£o do
> Dashboard Analytics

## üìã **Resumo dos Problemas Resolvidos**

Durante a implementa√ß√£o do Dashboard de Analytics e melhorias de code quality,
enfrentamos e resolvemos diversos problemas t√©cnicos importantes. Este documento
serve como refer√™ncia para futuras implementa√ß√µes e para orientar IAs sobre
solu√ß√µes j√° testadas.

---

## üö® **PROBLEMAS CR√çTICOS DE BUILD**

### **‚ùå Problema: "Module not found: Can't resolve '@/lib/validations'"**

#### **üîç Sintomas**

```bash
Failed to compile.

./app/api/contact/route.ts
Module not found: Can't resolve '@/lib/validations'

./app/api/quotes/route.ts
Module not found: Can't resolve '@/lib/validations'
```

#### **üß† Causa Raiz**

- O arquivo `lib/validations/index.ts` estava sendo deletado automaticamente
  pelo `prisma-zod-generator`
- O gerador do Prisma sobrescreve o diret√≥rio `lib/validations/` durante
  execu√ß√£o
- Scripts de `prebuild` executavam `prisma generate` que destru√≠a arquivos
  customizados

#### **‚úÖ Solu√ß√£o Implementada**

1. **Cria√ß√£o manual do arquivo** ap√≥s cada `prisma generate`:

```bash
# PowerShell
New-Item -Path lib\validations\index.ts -ItemType File -Force
```

2. **Conte√∫do m√≠nimo necess√°rio**:

```typescript
// lib/validations/index.ts
export { QuoteStatusSchema as QuoteStatus } from "./schemas/enums/QuoteStatus.schema"
export { RoleSchema as Role } from "./schemas/enums/Role.schema"

import { z } from "zod"

export const ContactSchema = z.object({
  name: z.string().min(1, "Nome √© obrigat√≥rio"),
  phone: z.string().min(1, "Telefone √© obrigat√≥rio"),
  email: z.string().email("Email inv√°lido"),
  company: z.string().optional(),
  equipments: z.string().optional(),
  message: z.string().min(1, "Mensagem √© obrigat√≥ria")
})

export const QuoteRequestSchema = z.object({
  customerName: z.string().min(1, "Nome √© obrigat√≥rio"),
  customerPhone: z.string().min(1, "Telefone √© obrigat√≥rio"),
  customerEmail: z.string().email("Email inv√°lido"),
  customerCompany: z.string().optional(),
  message: z.string().optional(),
  items: z
    .array(
      z.object({
        equipmentId: z.string().min(1),
        quantity: z.number().int().min(1),
        days: z.number().int().min(1)
      })
    )
    .min(1)
})
```

3. **Procedimento de emerg√™ncia**:

```bash
# Se o build falhar, execute:
pnpm db:generate
# Depois recrie o arquivo index.ts com o conte√∫do acima
# Ent√£o execute:
pnpm build
```

#### **üõ°Ô∏è Preven√ß√£o**

- **NUNCA delete** o arquivo `lib/validations/index.ts`
- **SEMPRE recrie** ap√≥s executar `prisma generate`
- **Considere prote√ß√£o** do arquivo via git ou scripts autom√°ticos

---

### **‚ùå Problema: "ssr: false is not allowed with next/dynamic in Server Components"**

#### **üîç Sintomas**

```bash
Error: x `ssr: false` is not allowed with `next/dynamic` in Server Components.
Please move it into a Client Component.
```

#### **üß† Causa Raiz**

- Componente `SwaggerUI` sendo importado dinamicamente em Server Component
- Next.js 15 tem regras mais r√≠gidas sobre SSR em App Router
- `swagger-ui-react` n√£o √© compat√≠vel com Server-Side Rendering

#### **‚úÖ Solu√ß√£o Implementada**

```typescript
// app/api-docs/page.tsx
'use client' // ‚Üê ADICIONAR ESTA LINHA

import 'swagger-ui-react/swagger-ui.css'
import dynamic from 'next/dynamic'

const SwaggerUI = dynamic(() => import('swagger-ui-react'), {
  ssr: false,
  loading: () => <p>Loading Component...</p>,
})

export default function ApiDocsPage() { // ‚Üê REMOVER 'async'
  return (
    <section>
      <SwaggerUI url="/openapi.json" />
    </section>
  )
}
```

#### **üõ°Ô∏è Preven√ß√£o**

- **SEMPRE use** `'use client'` para componentes com `dynamic` imports
- **REMOVA `async`** de componentes Client-side
- **TESTE o build** ap√≥s modifica√ß√µes em componentes din√¢micos

---

## üíª **PROBLEMAS DE CODE QUALITY**

### **‚ùå Problema: ESLint "Unexpected any" Warnings (70+ warnings)**

#### **üîç Sintomas**

```bash
./lib/telemetry.ts
47:30  Warning: Unexpected any. Specify a different type.  @typescript-eslint/no-explicit-any
90:30  Warning: Unexpected any. Specify a different type.  @typescript-eslint/no-explicit-any
```

#### **üß† Causa Raiz**

- Uso excessivo de tipo `any` em sistemas de telemetria e m√©tricas
- Falta de interfaces espec√≠ficas para objetos complexos
- Parameters gen√©ricos mal tipados

#### **‚úÖ Solu√ß√µes Implementadas**

**1. Substitui√ß√£o de `any` por `unknown`:**

```typescript
// ‚ùå Antes
function handleData(data: any) {
  // ...
}

// ‚úÖ Depois
function handleData(data: unknown) {
  // ...
}
```

**2. Cria√ß√£o de interfaces espec√≠ficas:**

```typescript
// lib/metrics.ts
interface RequestLike {
  url?: string
  method?: string
  headers?: Record<string, string | string[]>
  ip?: string
  connection?: { remoteAddress?: string }
  user?: { id?: string; role?: string }
}

interface ResponseLike {
  statusCode?: number
  send?: (body: unknown) => void
}
```

**3. Union types para variants:**

```typescript
// app/admin/analytics/page.tsx
<Badge
  variant={
    getSeverityColor(anomaly.severity) as
      | 'default'
      | 'destructive'
      | 'outline'
      | 'secondary'
  }
/>
```

**4. Generics tipados corretamente:**

```typescript
// lib/telemetry.ts
export function withTracing<T extends unknown[], R>(
  name: string,
  fn: (...args: T) => Promise<R> | R,
  attributes: Record<string, string | number | boolean> = {}
) {
  // ...
}
```

#### **üìä Resultado**

- **Antes**: ~70 warnings de `any` types
- **Depois**: ~6 warnings (apenas em arquivos auto-gerados)
- **Melhoria**: ~90% de redu√ß√£o

---

### **‚ùå Problema: "Variable is assigned but never used" Warnings**

#### **üîç Sintomas**

```bash
./app/api/contact/route.ts
16:9  Warning: 'validatedData' is assigned a value but never used.
```

#### **üß† Causa Raiz**

- Vari√°veis criadas para valida√ß√£o mas n√£o utilizadas posteriormente
- Resultado de opera√ß√µes necess√°rias mas valor n√£o consumido

#### **‚úÖ Solu√ß√µes Implementadas**

**1. Prefixo com underscore:**

```typescript
// ‚ùå Antes
const validatedData = ContactSchema.parse(body)

// ‚úÖ Depois
const _validatedData = ContactSchema.parse(body)
```

**2. Remo√ß√£o da vari√°vel (quando apenas valida√ß√£o):**

```typescript
// ‚úÖ Melhor ainda
ContactSchema.parse(body) // Apenas valida√ß√£o, sem armazenar
```

**3. Desestrutura√ß√£o para ignorar:**

```typescript
// Se apenas parte √© usada
const { name, _unusedField } = someObject
```

---

## üé® **PROBLEMAS DE UI/UX**

### **‚ùå Problema: Badge Variant Type Errors**

#### **üîç Sintomas**

```bash
Type 'string' is not assignable to type '"default" | "destructive" | "outline" | "secondary"'
```

#### **üß† Causa Raiz**

- Fun√ß√£o `getSeverityColor()` retorna `string`
- Component `Badge` espera union type espec√≠fico
- TypeScript n√£o consegue inferir o tipo correto

#### **‚úÖ Solu√ß√£o Implementada**

```typescript
// Fun√ß√£o helper com retorno tipado
const getSeverityColor = (severity: string): 'default' | 'destructive' | 'outline' | 'secondary' => {
  switch (severity.toLowerCase()) {
    case 'high': return 'destructive'
    case 'medium': return 'outline'
    default: return 'secondary'
  }
}

// Uso com cast expl√≠cito como fallback
<Badge
  variant={
    getSeverityColor(anomaly.severity) as
      | 'default'
      | 'destructive'
      | 'outline'
      | 'secondary'
  }
/>
```

---

### **‚ùå Problema: Anima√ß√µes N√£o Funcionando no Dashboard**

#### **üîç Sintomas**

- Componentes aparecendo sem transi√ß√µes suaves
- Gr√°ficos carregando abruptamente
- Falta de feedback visual em intera√ß√µes

#### **üß† Causa Raiz**

- Framer Motion n√£o configurado corretamente
- Componentes re-renderizando sem preservar estado de anima√ß√£o
- Falta de `AnimatePresence` para sa√≠da de elementos

#### **‚úÖ Solu√ß√µes Implementadas**

**1. AnimatePresence para conditional rendering:**

```typescript
import { AnimatePresence, motion } from 'framer-motion'

<AnimatePresence>
  {analytics.anomalies?.length > 0 && (
    <motion.div
      initial={{ opacity: 0, y: -20 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -20 }}
    >
      {/* Conte√∫do das anomalias */}
    </motion.div>
  )}
</AnimatePresence>
```

**2. Staggered animations para listas:**

```typescript
{analytics.topEndpoints.map((endpoint, i) => (
  <motion.div
    key={i}
    initial={{ opacity: 0, x: -20 }}
    animate={{ opacity: 1, x: 0 }}
    transition={{ delay: i * 0.05 }} // Stagger effect
  >
    {/* Item content */}
  </motion.div>
))}
```

**3. Layout animations para gr√°ficos:**

```typescript
<motion.div
  initial={{ height: 0 }}
  animate={{ height: `${Math.max(height, 2)}%` }}
  transition={{ delay: hour * 0.02 + 0.2, duration: 0.5 }}
  className="w-full rounded-t-sm bg-orange-500"
/>
```

---

## üîß **PROBLEMAS DE DEVELOPMENT WORKFLOW**

### **‚ùå Problema: PowerShell Syntax Errors**

#### **üîç Sintomas**

```bash
The term '&&' is not recognized as the name of a cmdlet, function, script file
```

#### **üß† Causa Raiz**

- PowerShell n√£o reconhece operador `&&` do bash/zsh
- Comandos concatenados n√£o funcionam nativamente
- Scripts de package.json podem falhar no Windows

#### **‚úÖ Solu√ß√µes Implementadas**

**1. Comandos individuais:**

```bash
# ‚ùå N√£o funciona no PowerShell
pnpm db:generate && pnpm build

# ‚úÖ Funciona
pnpm db:generate
pnpm build
```

**2. Scripts separados no package.json:**

```json
{
  "scripts": {
    "prebuild": "prisma generate",
    "build": "next build",
    "db:generate": "prisma generate"
  }
}
```

**3. Uso de npx quando necess√°rio:**

```bash
npx next build  # Em vez de usar scripts pnpm que podem falhar
```

---

## üìä **PROBLEMAS DE PERFORMANCE**

### **‚ùå Problema: Loading States Inadequados**

#### **üîç Sintomas**

- Dashboard carregando sem feedback visual
- Usu√°rio sem saber se aplica√ß√£o est√° funcionando
- Experi√™ncia ruim durante fetch de dados

#### **üß† Causa Raiz**

- Estados de loading n√£o implementados adequadamente
- Falta de skeleton screens
- Loading spinners simples demais

#### **‚úÖ Solu√ß√µes Implementadas**

**1. Skeleton screens detalhados:**

```typescript
{loading && (
  <div className="space-y-6 p-6">
    <div className="space-y-4">
      <Skeleton className="h-8 w-64" />
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {Array.from({ length: 4 }).map((_, i) => (
          <Card key={i} className="p-6">
            <Skeleton className="h-4 w-24 mb-2" />
            <Skeleton className="h-8 w-16 mb-1" />
            <Skeleton className="h-3 w-32" />
          </Card>
        ))}
      </div>
    </div>
  </div>
)}
```

**2. Loading spinners animados:**

```typescript
<RefreshCw className={`mr-2 h-4 w-4 ${loading ? 'animate-spin' : ''}`} />
```

**3. Estados de loading inteligentes:**

```typescript
const [loading, setLoading] = useState(true)
const [error, setError] = useState<string | null>(null)

// Loading apenas durante fetch, n√£o durante renders
```

---

## üîí **PROBLEMAS DE SEGURAN√áA E ACESSO**

### **‚ùå Problema: Middleware de Autentica√ß√£o Inconsistente**

#### **üîç Sintomas**

- APIs admin acess√≠veis sem autentica√ß√£o adequada
- Tipos de role n√£o verificados consistentemente
- Middleware n√£o aplicado uniformemente

#### **üß† Causa Raiz**

- Falta de padroniza√ß√£o nos middlewares de auth
- Verifica√ß√£o de roles manual e propensa a erros
- Imports din√¢micos quebrando verifica√ß√µes

#### **‚úÖ Solu√ß√µes Implementadas**

**1. Middleware padronizado:**

```typescript
// middlewares/require-admin.ts
export async function requireAdmin(request: NextRequest) {
  const session = await getServerSession(authOptions)

  if (!session?.user) {
    return NextResponse.json(
      { error: "Authentication required" },
      { status: 401 }
    )
  }

  if (session.user.role !== "ADMIN") {
    return NextResponse.json(
      { error: "Admin access required" },
      { status: 403 }
    )
  }

  return null // Success - continue
}
```

**2. Wrapper para APIs admin:**

```typescript
export const withAdminAuth = (handler: Function) => {
  return async (request: NextRequest, ...args: any[]) => {
    const authError = await requireAdmin(request)
    if (authError) return authError

    return handler(request, ...args)
  }
}
```

**3. Aplica√ß√£o consistente:**

```typescript
// app/api/admin/analytics/route.ts
export const GET = withAdminAuth(async (request: NextRequest) => {
  // L√≥gica do endpoint
})
```

---

## üìà **LI√á√ïES APRENDIDAS**

### **üéØ Principais Insights**

1. **Build Stability √© Cr√≠tico**
   - Sempre teste builds ap√≥s mudan√ßas em dependencies
   - Prisma generators podem quebrar arquivos customizados
   - Mantenha backups de arquivos cr√≠ticos

2. **Type Safety Paga Dividendos**
   - Investimento inicial em tipos corretos evita bugs futuros
   - `unknown` √© prefer√≠vel a `any` na maioria dos casos
   - Union types e interfaces espec√≠ficas melhoram DX

3. **UX Requer Aten√ß√£o aos Detalhes**
   - Loading states fazem diferen√ßa significativa na percep√ß√£o
   - Anima√ß√µes suaves melhoram profissionalismo
   - Error handling gracioso constr√≥i confian√ßa

4. **Documenta√ß√£o √© Ferramenta de Debug**
   - Problemas bem documentados aceleram resolu√ß√£o futura
   - IAs precisam de contexto hist√≥rico para evitar regress√µes
   - Solu√ß√µes testadas devem ser preservadas

### **‚ö†Ô∏è Armadilhas a Evitar**

1. **N√£o modificar arquivos auto-gerados** sem backup
2. **N√£o usar `any`** sem justificativa muito forte
3. **N√£o implementar UI** sem estados de loading/error
4. **N√£o fazer mudan√ßas** sem testar build completo
5. **N√£o ignorar warnings** de TypeScript/ESLint

### **üîÆ Prepara√ß√£o para Futuro**

1. **Monitoring Cont√≠nuo**: Sistema implementado detectar√° problemas antes
2. **Type Safety**: Base s√≥lida para expans√µes futuras
3. **Component Library**: Design system facilita novas features
4. **Documentation**: Base para onboarding de novos desenvolvedores
5. **Testing Infrastructure**: Prote√ß√£o contra regress√µes

---

## üìû **Suporte e Refer√™ncias**

### **üîó Links √öteis**

- **Documenta√ß√£o Principal**: `docs/README.md`
- **Guia de Desenvolvimento**: `docs/getting-started/development.md`
- **Dashboard Analytics**: `docs/features/analytics-dashboard.md`
- **Troubleshooting Geral**: `docs/getting-started/troubleshooting.md`

### **üö® Escala√ß√£o de Problemas**

1. **Consulte esta documenta√ß√£o** para problemas conhecidos
2. **Verifique logs** do browser e servidor
3. **Teste em ambiente limpo** (npm clean, rebuild)
4. **Documente novos problemas** para futuras refer√™ncias

---

**üìù Nota Final**: Este documento deve ser atualizado sempre que novos problemas
forem identificados e resolvidos. A documenta√ß√£o de problemas √© t√£o importante
quanto a documenta√ß√£o de funcionalidades.
