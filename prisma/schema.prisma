generator client {
  provider = "prisma-client-js"
}

generator zod {
  provider                         = "prisma-zod-generator"
  output                           = "../lib/validations"
  addInputTypeValidation           = "false"
  createInputTypes                 = "false"
  createOptionalDefaultValuesTypes = "true"
  createPartialTypes               = "true"
  createRelationValuesTypes        = "true"
  modelCase                        = "camelCase"
  modelSuffix                      = "Schema"
  prismaJsonNullability            = "true"
  relationModel                    = "true"
  useDecimalJs                     = "true"
  validateWhereUniqueInput         = "false"
  writeBarrelFiles                 = "true"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             String     @id @default(cuid())
  name           String?
  email          String     @unique
  password       String?
  role           Role       @default(CLIENT)
  emailVerified  DateTime?
  image          String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  cnpj           String?    @unique
  cpf            String?    @unique
  phone          String?
  accounts       Account[]
  addresses      Address[]
  auditLogs      AuditLog[]
  cart           Cart?
  approvedQuotes Quote[]    @relation("ApprovedQuotes")
  rejectedQuotes Quote[]    @relation("RejectedQuotes")
  quotes         Quote[]
  rentals        rentals[]
  sessions       Session[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@id([identifier, token])
  @@map("verificationtokens")
}

model Address {
  id           String   @id @default(cuid())
  userId       String
  street       String
  number       String
  complement   String?
  neighborhood String
  city         String
  state        String
  zipCode      String
  isPrimary    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  items     CartItem[]
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("carts")
}

model CartItem {
  id          String    @id @default(cuid())
  cartId      String
  equipmentId String
  quantity    Int
  days        Int
  pricePerDay Decimal
  finalPrice  Decimal?
  createdAt   DateTime  @default(now())
  cart        Cart      @relation(fields: [cartId], references: [id], onDelete: Cascade)
  equipment   Equipment @relation(fields: [equipmentId], references: [id])

  @@unique([cartId, equipmentId])
  @@index([equipmentId])
  @@map("cart_items")
}

model Category {
  id          String      @id @default(uuid()) @db.Uuid
  name        String
  description String?
  icon        String?
  iconColor   String      @default("#3B82F6")
  bgColor     String      @default("#EFF6FF")
  fontColor   String      @default("#1E40AF")
  slug        String      @unique
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  placement   String?
  customIcon  Json?
  equipments  Equipment[]

  @@map("categories")
}

model Equipment {
  id                     String          @id @default(cuid())
  name                   String
  description            String?
  pricePerDay            Decimal
  images                 String[]
  available              Boolean         @default(true)
  categoryId             String          @db.Uuid
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  biweeklyDiscount       Int?            @default(0)
  dailyDiscount          Int?            @default(0)
  maxStock               Int?            @default(1)
  monthlyDiscount        Int?            @default(0)
  popularPeriod          String?         @default("weekly")
  weeklyDiscount         Int?            @default(0)
  specifications         Json?
  biweeklyDirectValue    Decimal?
  biweeklyUseDirectValue Boolean         @default(false)
  dailyDirectValue       Decimal?
  dailyUseDirectValue    Boolean         @default(false)
  monthlyDirectValue     Decimal?
  monthlyUseDirectValue  Boolean         @default(false)
  weeklyDirectValue      Decimal?
  weeklyUseDirectValue   Boolean         @default(false)
  depreciationRate       Decimal?        @db.Decimal
  hourMeter              Decimal?        @db.Decimal
  odometer               Decimal?        @db.Decimal
  purchaseDate           DateTime?
  purchasePrice          Decimal?        @db.Decimal
  partsLossHistory       Json?          // Histórico de perdas de peças
  partsLossCount         Int?            @default(0) // Contador de perdas de peças
  cartItems              CartItem[]
  units                  EquipmentUnit[]
  category               Category        @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_category")
  maintenances           Maintenance[]
  quoteItems             QuoteItem[]
  rental_items           rental_items[]

  @@index([categoryId])
  @@map("equipments")
}

model EquipmentUnit {
  id           String              @id @default(cuid())
  equipmentId  String
  uniqueCode   String              @unique
  status       EquipmentUnitStatus @default(AVAILABLE)
  hourMeter    Decimal?            @db.Decimal
  odometer     Decimal?            @db.Decimal
  serialNumber String?
  notes        String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  equipment    Equipment           @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([equipmentId])
  @@index([status])
  @@index([uniqueCode])
  @@map("equipment_units")
}

model Quote {
  id                  String        @id @default(cuid())
  name                String
  email               String
  phone               String
  company             String?
  message             String?
  total               Decimal       @default(0)
  status              QuoteStatus   @default(PENDING)
  userId              String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  cep                 String?
  cnpj                String?
  cpf                 String?
  adminNotes          String?
  approvedAt          DateTime?
  approvedBy          String?
  convertedToRentalId String?
  deliveryAddress     Json?
  deliveryFee         Decimal?
  deliveryType        DeliveryType?
  deposit             Decimal?
  discount            Decimal?
  endDate             DateTime?
  finalTotal          Decimal?
  internalNotes       String?
  pickupFee           Decimal?
  priority            Int?          @default(0)
  rejectedAt          DateTime?
  rejectedBy          String?
  rejectionReason     String?
  startDate           DateTime?
  subtotal            Decimal?
  taxes               Decimal?
  validUntil          DateTime?
  // Sistema de ajuste de valor final com justificativa
  originalTotal       Decimal?          // Valor original completo (antes do ajuste)
  priceAdjustmentReason String?         // Justificativa obrigatória ao editar valor
  priceAdjustedAt     DateTime?        // Data/hora da edição do valor
  priceAdjustedBy     String?           // ID do usuário que editou o valor
  // Sistema de multa por atraso
  lateFee             Decimal?          // Valor da multa calculada
  lateFeeApproved     Boolean?          @default(false) // Se admin aprovou aplicação da multa
  lateFeeApprovedAt   DateTime?         // Data de aprovação da multa
  lateFeeApprovedBy   String?           // ID do admin que aprovou a multa
  // Registro de danos e mau uso
  damages             Json?             // Registro de danos
  misuse              Json?             // Registro de mau uso
  payments            Payment[]
  items               QuoteItem[]
  approvedByUser      User?         @relation("ApprovedQuotes", fields: [approvedBy], references: [id])
  rejectedByUser      User?         @relation("RejectedQuotes", fields: [rejectedBy], references: [id])
  user                User?         @relation(fields: [userId], references: [id])
  rentals             rentals[]

  @@index([userId])
  @@index([startDate])
  @@index([endDate])
  @@index([status])
  @@index([approvedBy])
  @@index([rejectedBy])
  @@map("quotes")
}

model QuoteItem {
  id              String    @id @default(cuid())
  quoteId         String
  equipmentId     String
  quantity        Int       @default(1)
  days            Int       @default(1)
  pricePerDay     Decimal
  total           Decimal
  // Datas específicas deste item (definidas na página de detalhes do equipamento)
  startDate       DateTime?
  endDate         DateTime?
  // Indica se finais de semana estão incluídos na contagem de dias
  includeWeekends Boolean   @default(false)
  // Informações de preço aplicado
  appliedDiscount Decimal? // Desconto percentual aplicado
  appliedPeriod   String? // Período aplicado (daily, weekly, biweekly, monthly)
  useDirectValue  Boolean   @default(false) // Se usou valor direto ao invés de desconto
  directValue     Decimal? // Valor direto aplicado (se useDirectValue = true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  equipment       Equipment @relation(fields: [equipmentId], references: [id])
  quote           Quote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([equipmentId])
  @@index([quoteId])
  @@index([startDate])
  @@index([endDate])
  @@map("quote_items")
}

model rental_items {
  id          String    @id
  rentalid    String
  equipmentid String
  quantity    Int       @default(1)
  priceperday Decimal   @db.Decimal
  totaldays   Int
  totalprice  Decimal   @db.Decimal
  createdat   DateTime? @default(now()) @db.Timestamp(6)
  updatedat   DateTime? @default(now()) @db.Timestamp(6)
  equipments  Equipment @relation(fields: [equipmentid], references: [id], onDelete: NoAction, onUpdate: NoAction)
  rentals     rentals   @relation(fields: [rentalid], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([equipmentid])
  @@index([rentalid])
}

model rentals {
  id            String         @id
  startdate     DateTime       @db.Timestamp(6)
  enddate       DateTime       @db.Timestamp(6)
  total         Decimal        @db.Decimal
  status        String?        @default("PENDING")
  userid        String
  createdat     DateTime?      @default(now()) @db.Timestamp(6)
  updatedat     DateTime?      @default(now()) @db.Timestamp(6)
  checkInAt     DateTime?      @db.Timestamp(6)
  checkOutAt    DateTime?      @db.Timestamp(6)
  extensionDays Int?
  extensionFee  Decimal?       @db.Decimal
  lateFee       Decimal?       @db.Decimal
  notes         String?
  quoteId       String?
  contract      Contract?
  deliveries    Delivery[]
  payments      Payment[]
  rental_items  rental_items[]
  quote         Quote?         @relation(fields: [quoteId], references: [id])
  users         User           @relation(fields: [userid], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([userid])
  @@index([quoteId])
  @@index([status])
  @@index([startdate])
  @@index([enddate])
}

model Setting {
  id                  String   @id @default(uuid())
  companyPhone        String   @default("")
  companyIconUrl      String   @default("")
  aboutUsText         String   @default("")
  companyAddress      String   @default("")
  heroCarousel        Json     @default("[]")
  contactEmail        String   @default("")
  socialLinks         Json     @default("{}")
  seoTitle            String   @default("GB Locações - Equipamentos para Construção")
  seoDescription      String   @default("Locação de equipamentos para construção civil com qualidade e segurança")
  themeColorPrimary   String   @default("#ea580c")
  maintenanceMode     Boolean  @default(false)
  analyticsTrackingId String   @default("")
  footerText          String   @default("")
  businessHours       Json     @default("{}")
  supportChat         Boolean  @default(true)
  whatsappNumber      String   @default("")
  favicon             String   @default("")
  logoSecondary       String   @default("")
  defaultLanguage     String   @default("pt-BR")
  baseCurrency        String   @default("BRL")
  maintenanceMessage  String   @default("Site em manutenção. Voltamos em breve!")
  smtpConfig          Json     @default("{}")
  uploadLimits        Json     @default("{}")
  securityConfig      Json     @default("{}")
  customCss           String   @default("")
  customJs            String   @default("")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  marketingEmail      String   @default("")
  waveAnimation       String   @default("animated")

  @@map("settings")
}

model Maintenance {
  id          String            @id @default(cuid())
  equipmentId String
  type        MaintenanceType
  scheduledAt DateTime
  completedAt DateTime?
  cost        Decimal?          @db.Decimal
  laborCost   Decimal?          @db.Decimal
  partsCost   Decimal?          @db.Decimal
  description String?
  notes       String?
  technician  String?
  status      MaintenanceStatus @default(SCHEDULED)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  equipment   Equipment         @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([equipmentId])
  @@index([scheduledAt])
  @@index([status])
  @@map("maintenances")
}

model Payment {
  id            String        @id @default(cuid())
  rentalId      String?
  quoteId       String?
  amount        Decimal       @db.Decimal
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  type          PaymentType   @default(RENTAL)
  paidAt        DateTime?     @db.Timestamp(6)
  dueDate       DateTime      @db.Timestamp(6)
  invoiceNumber String?
  transactionId String?
  pixCode       String?
  pixQrCode     String?
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  quote         Quote?        @relation(fields: [quoteId], references: [id])
  rental        rentals?      @relation(fields: [rentalId], references: [id])

  @@index([rentalId])
  @@index([quoteId])
  @@index([status])
  @@index([dueDate])
  @@index([method])
  @@map("payments")
}

model Delivery {
  id          String         @id @default(cuid())
  rentalId    String
  type        DeliveryType
  status      DeliveryStatus @default(SCHEDULED)
  scheduledAt DateTime
  completedAt DateTime?      @db.Timestamp(6)
  address     Json
  distance    Decimal?       @db.Decimal
  vehicleId   String?
  driverId    String?
  driverName  String?
  photos      String[]
  checklist   Json?
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  rental      rentals        @relation(fields: [rentalId], references: [id], onDelete: Cascade)

  @@index([rentalId])
  @@index([status])
  @@index([scheduledAt])
  @@index([type])
  @@map("deliveries")
}

model Vehicle {
  id        String        @id @default(cuid())
  plate     String        @unique
  brand     String?
  model     String?
  year      Int?
  type      VehicleType   @default(TRUCK)
  status    VehicleStatus @default(AVAILABLE)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@map("vehicles")
}

model Driver {
  id          String       @id @default(cuid())
  name        String
  phone       String
  cnh         String?
  cnhCategory String?
  status      DriverStatus @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("drivers")
}

model Contract {
  id        String         @id @default(cuid())
  rentalId  String         @unique
  template  String?
  content   String?
  pdfUrl    String?
  signedAt  DateTime?
  signedBy  String?
  zapSignId String?
  status    ContractStatus @default(DRAFT)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  rental    rentals        @relation(fields: [rentalId], references: [id], onDelete: Cascade)

  @@index([rentalId])
  @@index([status])
  @@map("contracts")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String
  changes   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Permission {
  id        String   @id @default(cuid())
  role      Role
  module    String
  action    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([role, module, action])
  @@index([role])
  @@map("permissions")
}

enum Role {
  ADMIN
  CLIENT
}

enum QuoteStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum DeliveryStatus {
  SCHEDULED
  IN_TRANSIT
  COMPLETED
  CANCELLED
  FAILED
}

enum DeliveryType {
  DELIVERY
  PICKUP
}

enum PaymentMethod {
  PIX
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  CASH
  BOLETO
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

enum PaymentType {
  RENTAL
  DEPOSIT
  FINE
  DAMAGE
  LATE_FEE
}

enum RentalItemStatus {
  RENTED
  RETURNED
  DAMAGED
  LOST
}

enum RentalStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  OVERDUE
  PENDING_RETURN
}

enum UserRole {
  ADMIN
  OPERATOR
  FINANCIAL
  CUSTOMER
}

enum delivery_type {
  pickup
  delivery
  both
}

enum quote_status {
  pending
  approved
  rejected
  expired
}

enum user_role {
  ADMIN
  OPERATOR
  FINANCIAL
  CUSTOMER
}

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
  INSPECTION
}

enum MaintenanceStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum VehicleType {
  TRUCK
  VAN
  PICKUP
  MOTORCYCLE
}

enum VehicleStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  OUT_OF_SERVICE
}

enum DriverStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
}

enum ContractStatus {
  DRAFT
  SENT
  SIGNED
  EXPIRED
  CANCELLED
}

enum EquipmentUnitStatus {
  AVAILABLE
  RESERVED
  RENTED
  MAINTENANCE
  RETIRED
}
